name: Comprehensive Security

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  secret-scanning:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install detect-secrets pip-audit safety

    - name: Scan repository history with Trufflehog
      uses: trufflesecurity/trufflehog@main
      continue-on-error: true
      with:
        path: ./
        extra_args: --only-verified

    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        format: spdx-json
        output-file: sbom.spdx.json

    - name: Run pip-audit on dependencies
      run: |
        pip-audit --requirement requirements.txt --format json --output audit.json || true
        pip-audit --requirement requirements.txt || true

    - name: Run safety check
      run: |
        safety check --json --output safety.json || true
        safety check

    - name: Upload security artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          sbom.spdx.json
          audit.json
          safety.json
        retention-days: 30

    - name: Container Security (if applicable)
      if: hashFiles('Dockerfile') != ''
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy results
      uses: actions/upload-artifact@v4
      if: hashFiles('Dockerfile') != ''
      with:
        name: container-security
        path: trivy-results.sarif
        retention-days: 30

  security-reporting:
    runs-on: ubuntu-latest
    needs: secret-scanning
    if: always()
    steps:
    - name: Download security artifacts
      uses: actions/download-artifact@v7
      with:
        name: security-reports
        path: security-reports/

    - name: Security Summary
      run: |
        echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "security-reports/sbom.spdx.json" ]; then
          echo "### ðŸ“‹ SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… SBOM generated successfully with dependency inventory" >> $GITHUB_STEP_SUMMARY
        fi

        if [ -f "security-reports/audit.json" ]; then
          echo "### ðŸ“¦ Dependency Audit" >> $GITHUB_STEP_SUMMARY
          echo "âœ… pip-audit completed - check artifacts for details" >> $GITHUB_STEP_SUMMARY
        fi

        if [ -f "security-reports/safety.json" ]; then
          echo "### ðŸ›¡ï¸  Safety Check" >> $GITHUB_STEP_SUMMARY
          echo "âœ… safety check completed - check artifacts for details" >> $GITHUB_STEP_SUMMARY
        fi

        if [ -f "container-security/trivy-results.sarif" ]; then
          echo "### ðŸ³ Container Security" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Container security scan completed - check artifacts for details" >> $GITHUB_STEP_SUMMARY
        fi
